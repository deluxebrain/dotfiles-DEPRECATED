#!/usr/bin/env bash

_SCRIPT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

DEPENDS_ON path \
	exists 

USE_GLOBAL_ERROR_HANDLER

setup_seil()
{
	# As required by Seil when remapping the caps lock key:
	# Umap the caps lock key within OS X preferences
	msg_info "Running unmap_caps.scpt"
	osascript ./unmap_caps.scpt

	# Run in Seil default
	msg_info "Running in Seil defaults from seil_import ..."
	. ./seil_import 

	# Restart Seil
	msg_info "Restarting Seil ..."
	/Applications/Seil.app/Contents/Library/bin/seil relaunch
}

setup_karabiner()
{
	# Grant accessibility access to Karabiner
	msg_info "Granting accessibility access to the Karabiner AXNotifier app ..."
	sudo tccutil -i org.pqrs.Karabiner-AXNotifier

	# Steps to create the plist in the first place:
	# plutil -convert xml1 -o ~/tmp/karabiner.plist ~/Library/Preferences/org.pqrs.Karabiner.plist
	msg_info "Running plist defaults into Karabiner from karabiner.plist ..."
	defaults import org.pqrs.Karabiner ./karabiner.plist

	# Run in Karabiner defaults
	msg_info "Running in Karabiner defaults from karabiner_import ..."
	. ./karabiner_import
	
	# Restart Karabina
	msg_info "Restarting Karabiner ..."
	/Applications/Karabiner.app/Contents/Library/bin/karabiner relaunch
}

main()
{
	cd "$_SCRIPT_PATH" || exit 1

	setup_seil
	setup_karabiner 
}

main 
exit $?
