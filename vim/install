#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$DIR" || exit

function run_custom_installer()
{
  local repos_name repos_path
  repos_name="$1"
  repos_path="$2"

  if [ -f "$repos_name" ]; then
    echo "Found custom installer for $repos_name"
    # shellcheck source=/dev/null
    . "${repos_name}.sh" "$repos_path"
  else
    msg_info "No custom installer found for $repos_name"
  fi
}

function generate_helptags()
{
  if [ -d "./doc" ]; then
    echo "Generating helptags from doc directory" >&2
    vim -u NONE -c "helptags doc" -c -q
  else
    echo "No helptags to generate" >&2
  fi
}

function main()
{
  local bundles_path
  local bundle_path
  local repos_name

  bundles_path="./vim.dotfile/bundle"
  for bundle_path in "${bundles_path}"/*; do
  (
    cd "$bundle_path" || return
    repos_name="$(git name)"
    echo "Installing vim plugin $repos_name" >&2
    git submodule update --init --recursive

    echo "Running custom installer for $repos_name" >&2
    run_custom_installer "$repos_name"

    echo "Generating help tags for $repos_name" >&2
    generate_helptags
  )
  done
}

main "$@"
exit $?

